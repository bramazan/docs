---
title: Payment Failures
description: Diagnose and resolve payment processing failures
icon: 'credit-card-front'
---

# Payment Failure Troubleshooting

Comprehensive guide to diagnosing and resolving payment failures.

## Quick Diagnosis

Follow this step-by-step process to identify the issue:

<Steps>
  <Step title="Identify Failure Stage">
    **Before API Call?** → Client-side validation or network issue
    
    **After API Call?** → Check HTTP status code and response
  </Step>
  
  <Step title="Check HTTP Status">
    | Status | Issue Type | Action |
    |--------|------------|--------|
    | **400** | Invalid request | Review request format and required fields |
    | **401/403** | Authentication | Verify API key and permissions |
    | **429** | Rate limited | Implement exponential backoff |
    | **500** | Server error | Retry with backoff, check status page |
    | **200** | Payment processed | Check payment status in response |
  </Step>
  
  <Step title="Review Payment Status">
    If HTTP 200 but payment failed:
    
    - **Status: FAILED** → Card declined by bank (see error code)
    - **Status: REQUIRES_3DS** → Redirect user to 3D Secure authentication
    - **Status: PROCESSING** → Payment is being processed, poll for updates
  </Step>
  
  <Step title="Handle Error Code">
    Common error codes:
    - `CARD_DECLINED` → Try different card
    - `INSUFFICIENT_FUNDS` → Suggest alternative payment method
    - `EXPIRED_CARD` → Request updated card details
    - `INVALID_CVV` → Ask user to re-enter CVV
    - `3DS_FAILED` → Authentication failed, allow retry
  </Step>
</Steps>

## Common Failure Scenarios

### Scenario 1: "Card Declined" Errors

**Symptoms**:
- API returns 200 OK
- Payment status is `FAILED`
- Error code: `CARD_DECLINED`

**Possible Causes**:

<Tabs>
  <Tab title="Insufficient Funds">
    **Error**: `INSUFFICIENT_FUNDS`
    
    **User Action**:
    - Try different card
    - Reduce amount
    - Check with bank
    
    **Your Action**:
    ```javascript
    if (error.code === 'INSUFFICIENT_FUNDS') {
      // Suggest alternative
      showAlternativePaymentMethods();
      
      // Or offer payment plan
      offerInstallmentOption();
    }
    ```
  </Tab>
  
  <Tab title="Card Security">
    **Error**: `CARD_BLOCKED`, `STOLEN_CARD`, `FRAUD_SUSPECTED`
    
    **User Action**:
    - Contact bank immediately
    - Verify card ownership
    
    **Your Action**:
    ```javascript
    if (['CARD_BLOCKED', 'STOLEN_CARD'].includes(error.code)) {
      showError(
        'There\'s an issue with this card. Please contact your bank or try a different card.'
      );
      logSecurityEvent(transaction);
    }
    ```
  </Tab>
  
  <Tab title="Card Limits">
    **Error**: `TRANSACTION_LIMIT_EXCEEDED`, `DAILY_LIMIT_EXCEEDED`
    
    **User Action**:
    - Contact bank to increase  limit
    - Try smaller amount
    - Use different card
    
    **Your Action**:
    ```javascript
    if (error.code.includes('LIMIT_EXCEEDED')) {
      showError(
        'This transaction exceeds your card limit. Try a smaller amount or different card.'
      );
    }
    ```
  </Tab>
  
  <Tab title="Card Type Issues">
    **Error**: `CARD_NOT_SUPPORTED`, `ONLINE_PAYMENTS_DISABLED`
    
    **Common Causes**:
    - Debit card not enabled for online shopping
    - Corporate card with restrictions
    - International card blocked
    
    **Your Action**:
    ```javascript
    if (error.code === 'ONLINE_PAYMENTS_DISABLED') {
      showError(
        'This card isn\'t enabled for online payments. Please use a different card or contact your bank to enable online transactions.'
      );
    }
    ```
  </Tab>
</Tabs>

---

### Scenario 2: Invalid Card Data

**Symptoms**:
- API returns 400 Bad Request
- Error before payment is attempt

**Solutions**:

<CodeGroup>

```javascript Validate Card Number
function validateCardNumber(number) {
  // Remove spaces and dashes
  const cleaned = number.replace(/[\s-]/g, '');
  
  // Check length
  if (cleaned.length < 13 || cleaned.length > 19) {
    return false;
  }
  
  // Luhn algorithm
  let sum = 0;
  let isEven = false;
  
  for (let i = cleaned.length - 1; i >= 0; i--) {
    let digit = parseInt(cleaned[i]);
    
    if (isEven) {
      digit *= 2;
      if (digit > 9) digit -= 9;
    }
    
    sum += digit;
    isEven = !isEven;
  }
  
  return sum % 10 === 0;
}
```

```javascript Validate Expiry
function validateExpiry(month, year) {
  const now = new Date();
  const currentYear = now.getFullYear();
  const currentMonth = now.getMonth() + 1;
  
  const expiryYear = parseInt(year);
  const expiryMonth = parseInt(month);
  
  // Check format
  if (expiryMonth < 1 || expiryMonth > 12) {
    throw new Error('Invalid month');
  }
  
  // Check expiration
  if (expiryYear < currentYear) {
    throw new Error('Card expired');
  }
  
  if (expiryYear === currentYear && expiryMonth < currentMonth) {
    throw new Error('Card expired');
  }
  
  return true;
}
```

```javascript Validate CVV
function validateCVV(cvv, cardBrand) {
  // Amex uses 4 digits, others use 3
  const expectedLength = cardBrand === 'AMEX' ? 4 : 3;
  
  if (cvv.length !== expectedLength) {
    return false;
  }
  
  // Must be all digits
  return /^\d+$/.test(cvv);
}
```

</CodeGroup>

---

### Scenario 3: Network/Timeout Issues

**Symptoms**:
- No response from API
- Request timeout
- Network error

**Debugging Steps**:

<Steps>
  <Step title="Check Connectivity">
    ```javascript
    if (!navigator.onLine) {
      showError('No internet connection');
      return;
    }
    ```
  </Step>
  
  <Step title="Verify API Endpoint">
    ```bash
    # Test connectivity
    curl -I https://api.odeal.com/v1/status
    
    # Should return 200 OK
    ```
  </Step>
  
  <Step title="Check Firewall/Proxy">
    Ensure your firewall/proxy allows:
    - Outbound HTTPS (443) to `api.odeal.com`
    - Outbound HTTPS (443) to `3ds.odeal.com` (for 3D Secure)
  </Step>
  
  <Step title="Implement Retry Logic">
    ```javascript
    async function retryPayment(paymentFn, maxRetries = 3) {
      for (let i = 0; i < maxRetries; i++) {
        try {
          return await paymentFn();
        } catch (error) {
          if (i === maxRetries - 1) throw error;
          
          // Exponential backoff
          const delay = Math.pow(2, i) * 1000;
          await new Promise(r => setTimeout(r, delay));
        }
      }
    }
    ```
  </Step>
</Steps>

---

### Scenario 4: Currency Issues

**Error Code**: `CURRENCY_NOT_SUPPORTED`

**Causes**:
- Currency not enabled for merchant
- Bank doesn't support currency
- Invalid currency code

**Solutions**:

```javascript
// Check supported currencies
const SUPPORTED_CURRENCIES = ['TRY', 'USD', 'EUR'];

function validateCurrency(currency) {
  if (!SUPPORTED_CURRENCIES.includes(currency)) {
    throw new Error(`Currency ${currency} not supported. Supported: ${SUPPORTED_CURRENCIES.join(', ')}`);
  }
}

// Fallback to default currency
function getPaymentCurrency(preferredCurrency) {
  return SUPPORTED_CURRENCIES.includes(preferredCurrency) 
    ? preferredCurrency 
    : 'TRY'; // Default
}
```

---

## Debugging Checklist

<Steps>
  <Step title="Collect Error Information">
    - Request ID
    - Error code and message
    - Payment ID (if created)
    - Timestamp
    - User's card type
  </Step>
  
  <Step title="Reproduce in Test">
    ```javascript
    // Try same request in test environment
    const testPayment = await fetch('https://api-test.odeal.com/v1/payments', {
      // ... same request
    });
    ```
  </Step>
  
  <Step title="Check API Status">
    Visit [Status Page](/resources/status) for known issues
  </Step>
  
  <Step title="Review Logs">
    ```javascript
    // Log all payment attempts
    console.log('[Payment Attempt]', {
      amount,
      currency,
      cardBrand,
      timestamp: new Date().toISOString(),
      requestId: response.requestId
    });
    ```
  </Step>
  
  <Step title="Test with Different Card">
    Use test cards to isolate issue:
    - Success card: `4111111111111111`
    - Declined card: `4000000000000002`
  </Step>
</Steps>

---

## Monitoring & Prevention

### Track Failure Rates

```javascript
// Track payment success/failure metrics
const metrics = {
  total: 0,
  succeeded: 0,
  failed: 0,
  failureReasons: {}
};

function trackPayment(result) {
  metrics.total++;
  
  if (result.status === 'SUCCEEDED') {
    metrics.succeeded++;
  } else {
    metrics.failed++;
    metrics.failureReasons[result.error.code] = 
      (metrics.failureReasons[result.error.code] || 0) + 1;
  }
  
  // Alert if failure rate > 10%
  const failureRate = metrics.failed / metrics.total;
  if (failureRate > 0.1) {
    alertOps('High payment failure rate:', failureRate);
  }
}
```

### Implement Alerts

```javascript
// Alert on specific error patterns
function checkForIssues(error) {
  // Multiple failures from same user
  if (getUserFailureCount(userId) > 3) {
    notifySupport(`User ${userId} has 3+ failed payments`);
  }
  
  // Spike in specific error
  if (getErrorCount('CARD_DECLINED', '1h') > 100) {
    alertOps('Spike in card declines');
  }
  
  // Server errors
  if (error.status >= 500) {
    alertOps('Server error:', error.requestId);
  }
}
```

---

## Best Practices

<AccordionGroup>
  <Accordion title="Provide Clear Error Messages">
    ```javascript
    const userFriendlyMessages = {
      'CARD_DECLINED': 'Your card was declined. Please try another card.',
      'INSUFFICIENT_FUNDS': 'Insufficient funds. Please use a different card.',
      'EXPIRED_CARD': 'This card has expired. Please use a different card.',
      'INVALID_CVV': 'Invalid security code. Please check and try again.',
      'NETWORK_ERROR': 'Connection failed. Please check your internet and try again.'
    };
    
    showError(userFriendlyMessages[error.code] || 'Payment failed. Please try again.');
    ```
  </Accordion>
  
  <Accordion title="Don't Retry Automatically">
    Card declines usually won't succeed on retry. Instead:
    - Show clear error
    - Suggest alternative payment method
    - Allow user to manually retry with corrections
    
    ```javascript
    // ❌ Don't do this
    if (payment.status === 'FAILED') {
      return retryPayment(); // Will likely fail again
    }
    
    // ✅ Do this
    if (payment.status === 'FAILED') {
      showError('Payment failed. Please try a different card.');
      enableCardEdit();
    }
    ```
  </Accordion>
  
  <Accordion title="Log for Support">
    ```javascript
    // Detailed logging for support team
    if (payment.status === 'FAILED') {
      logError({
        level: 'error',
        message: 'Payment failed',
        paymentId: payment.id,
        requestId: payment.requestId,
        errorCode: payment.error.code,
        amount: payment.amount,
        currency: payment.currency,
        userId: currentUser.id,
        timestamp: new Date().toISOString(),
        userAgent: navigator.userAgent
      });
    }
    ```
  </Accordion>
  
  <Accordion title="Test Failure Scenarios">
    ```javascript
    // Test error handling
    describe('Payment Failures', () => {
      it('handles card declined', async () => {
        const result = await processPayment({
          card: { number: '4000000000000002' } // Test declined card
        });
        
        expect(result.error.code).toBe('CARD_DECLINED');
        expect(screen.getByText(/declined/i)).toBeInTheDocument();
      });
      
      it('handles network error', async () => {
        mockNetworkFailure();
        // ... test error handling
      });
    });
    ```
  </Accordion>
</AccordionGroup>

---

## Getting Help

If you can't resolve the issue:

1. **Check Documentation**: [Common Errors](/troubleshooting/common-errors)
2. **Check Status**: [System Status](/resources/status)
3. **Contact Support**: Include request ID and error details
4. **Community**: Ask in [Discord](https://discord.gg/odeal)

<Info>
Premium and Enterprise customers get priority support with <2h response time.
</Info>
