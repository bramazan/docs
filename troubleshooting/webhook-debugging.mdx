---
title: Webhook Debugging
description: Troubleshoot webhook delivery and processing issues
icon: 'webhook'
---

# Webhook Debugging Guide

Diagnose and resolve webhook delivery and processing issues.

## Diagnostic Checklist

<AccordionGroup>
  <Accordion title="Step 1: Verify Webhook Registration" icon="check">
    ```bash
    # Check registered webhooks
    curl -X GET https://api.odeal.com/v1/webhooks \
      -H "Authorization: Bearer YOUR_API_KEY"
    ```
    
    **What to verify:**
    - ✅ Webhook URL is correct
    - ✅ Events are subscribed
    - ✅ Webhook is active (not paused)
  </Accordion>
  
  <Accordion title="Step 2: Test Endpoint Accessibility" icon="globe">
    ```bash
    # Test from external service
    curl -X POST https://yoursite.com/webhooks/odeal \
      -H "Content-Type: application/json" \
      -d '{"test": "data"}'
    ```
    
    **Requirements:**
    - ✅ HTTPS enabled
    - ✅ Publicly accessible
    - ✅ Valid SSL certificate
    - ✅ Not blocked by firewall
  </Accordion>
  
  <Accordion title="Step 3: Verify Signature" icon="shield">
    Most common issue! Ensure you're:
    - ✅ Using webhook secret (not API key)
    - ✅ Hashing raw request body
    - ✅ Using HMAC-SHA256 algorithm
    - ✅ Comparing in constant time
  </Accordion>
  
  <Accordion title="Step 4: Check Response Time" icon="clock">
    **Must respond within 30 seconds**
    
    - ✅ Return 200 immediately
    - ✅ Process webhook asynchronously
    - ✅ Don't wait for database operations
    - ✅ Queue heavy processing
  </Accordion>
  
  <Accordion title="Step 5: Handle Duplicates" icon="copy">
    Implement idempotency:
    - ✅ Check webhook ID before processing
    - ✅ Store processed IDs in database
    - ✅ Return 200 for duplicates
  </Accordion>
</AccordionGroup>

## Common Issues

### Issue 1: Webhooks Not Being Delivered

**Check webhook registration**:

```bash
# List registered webhooks
curl -X GET https://api.odeal.com/v1/webhooks \
  -H "Authorization: Bearer YOUR_API_KEY"
```

**Register webhook if missing**:

```javascript
const webhook = await fetch('https://api.odeal.com/v1/webhooks', {
  method: 'POST',
  headers: {
    'Authorization': 'Bearer YOUR_API_KEY',
    'Content-Type': 'application/json'
  },
  body: JSON.stringify({
    url: 'https://yoursite.com/webhooks/odeal',
    events: ['payment.succeeded', 'payment.failed', 'refund.completed'],
    active: true
  })
});
```

---

### Issue 2: Endpoint Not Accessible

**Requirements**:
- Must be HTTPS (except localhost in test)
- Must be publicly accessible
- Must respond within 30 seconds
- Must return 2xx status code

**Test accessibility**:

```bash
# Test from external service
curl -X POST https://yoursite.com/webhooks/odeal \
  -H "Content-Type: application/json" \
  -d '{"test": "data"}'
  
# Should return 200 OK
```

**Common problems**:

<Tabs>
  <Tab title="Localhost">
    **Problem**: Using localhost URL
    
    **Solution for Local Development**:
    ```bash
    # Use ngrok for testing
    ngrok http 3000
    
    # Register the ngrok URL
    # https://abc123.ngrok.io/webhooks/odeal
    ```
  </Tab>
  
  <Tab title="Firewall">
    **Problem**: Firewall blocking incoming requests
    
    **Solution**:
    - Whitelist Ödeal webhook IPs: `185.x.x.x/24`
    - Or allow all HTTPS traffic on port 443
  </Tab>
  
  <Tab title="SSL Certificate">
    **Problem**: Invalid SSL certificate
    
    **Check**:
    ```bash
    openssl s_client -connect yoursite.com:443 -servername yoursite.com
    ```
    
    **Solution**: Ensure valid SSL certificate from trusted CA
  </Tab>
</Tabs>

---

### Issue 3: Signature Verification Fails

** Verify webhook signature**:

```javascript
const crypto = require('crypto');

function verifyWebhookSignature(payload, signature, secret) {
  const expectedSignature = crypto
    .createHmac('sha256', secret)
    .update(payload)
    .digest('hex');
    
  return crypto.timingSafeEqual(
    Buffer.from(signature),
    Buffer.from(expectedSignature)
  );
}

// Usage
app.post('/webhooks/odeal', (req, res) => {
  const signature = req.headers['x-odeal-signature'];
  const payload = JSON.stringify(req.body);
  
  if (!verifyWebhookSignature(payload, signature, WEBHOOK_SECRET)) {
    return res.status(401).send('Invalid signature');
  }
  
  // Process webhook
  processWebhook(req.body);
  
  res.status(200).send('OK');
});
```

**Common mistakes**:

<AccordionGroup>
  <Accordion title="Wrong Payload Format">
    ```javascript
    // ❌ Wrong - modified body
    const payload = req.body; // Already parsed as object
    
    // ✅ Correct - raw body
    const payload = req.rawBody; // Or JSON.stringify(req.body)
    ```
    
    **Express.js setup**:
    ```javascript
    app.use(express.json({
      verify: (req, res, buf) => {
        req.rawBody = buf.toString('utf8');
      }
    }));
    ```
  </Accordion>
  
  <Accordion title="Wrong Secret">
    ```javascript
    // Ensure you're using the webhook secret, not API key
    const WEBHOOK_SECRET = process.env.ODEAL_WEBHOOK_SECRET;
    // NOT: process.env.ODEAL_API_KEY
    ```
    
    Get webhook secret from dashboard or API response when creating webhook.
  </Accordion>
  
  <Accordion title="Encoding Issues">
    ```javascript
    // Ensure consistent encoding
    const expectedSignature = crypto
      .createHmac('sha256', secret)
      .update(payload, 'utf8') // Explicit encoding
      .digest('hex');
    ```
  </Accordion>
</AccordionGroup>

---

### Issue 4: Webhook Timing Out

**Causes**:
- Endpoint takes > 30s to respond
- Synchronous processing of heavy operations
- Database locks

**Solutions**:

```javascript
// ❌ Bad - synchronous processing
app.post('/webhooks/odeal', async (req, res) => {
  await processOrder(req.body); // Might take minutes
  await sendEmails(req.body);
  await updateAnalytics(req.body);
  
  res.status(200).send('OK'); // Timeout!
});

// ✅ Good - async processing
app.post('/webhooks/odeal', async (req, res) => {
  // Verify signature
  if (!verifySignature(req)) {
    return res.status(401).send('Invalid');
  }
  
  // Respond immediately
  res.status(200).send('OK');
  
  // Process asynchronously
  queueJob('process-webhook', req.body);
});

// Process in background worker
async function processWebhookJob(data) {
  await processOrder(data);
  await sendEmails(data);
  await updateAnalytics(data);
}
```

---

### Issue 5: Duplicate Webhooks

**Cause**: Webhook retries due to timeout or errors

**Solution**: Implement idempotency

```javascript
const processedWebhooks = new Set();

app.post('/webhooks/odeal', async (req, res) => {
  const webhookId = req.body.id;
  
  // Check if already processed
  if (processedWebhooks.has(webhookId)) {
    console.log('Webhook already processed:', webhookId);
    return res.status(200).send('OK');
  }
  
  // Process webhook
  await processWebhook(req.body);
  
  // Mark as processed
  processedWebhooks.add(webhookId);
  
  res.status(200).send('OK');
});

// Or use database
async function isWebhookProcessed(webhookId) {
  const exists = await db.webhooks.findOne({ id: webhookId });
  return !!exists;
}

async function markWebhookProcessed(webhookId) {
  await db.webhooks.create({
    id: webhookId,
    processedAt: new Date()
  });
}
```

---

## Testing Webhooks

### Test Locally with ngrok

```bash
# 1. Start your local server
npm run dev # Running on port 3000

# 2. Start ngrok
ngrok http 3000

# 3. Register ngrok URL
curl -X POST https://api.odeal.com/v1/webhooks \
  -H "Authorization: Bearer YOUR_API_KEY" \
  -H "Content-Type: application/json" \
  -d '{
    "url": "https://abc123.ngrok.io/webhooks/odeal",
    "events": ["payment.succeeded"]
  }'

# 4. Trigger a test payment
# Webhook will be delivered to your local server
```

### Trigger Test Webhook

```bash
# Manually trigger webhook (test environment)
curl -X POST https://api-test.odeal.com/v1/webhooks/test \
  -H "Authorization: Bearer YOUR_TEST_API_KEY" \
  -H "Content-Type: application/json" \
  -d '{
    "webhookId": "wh_123",
    "event": "payment.succeeded",
    "data": {
      "paymentId": "pay_test_123",
      "amount": 100.00,
      "status": "SUCCEEDED"
    }
  }'
```

### Mock Webhooks for Testing

```javascript
// Test webhook handler
describe('Webhook Handler', () => {
  it('processes payment.succeeded event', async () => {
    const mockEvent = {
      id: 'evt_123',
      type: 'payment.succeeded',
      data: {
        id: 'pay_123',
        amount: 100.00,
        status: 'SUCCEEDED'
      }
    };
    
    const response = await request(app)
      .post('/webhooks/odeal')
      .set('X-Odeal-Signature', generateSignature(mockEvent))
      .send(mockEvent);
      
    expect(response.status).toBe(200);
    
    // Verify order was updated
    const order = await db.orders.findOne({ paymentId: 'pay_123' });
    expect(order.status).toBe('PAID');
  });
  
  it('rejects invalid signature', async () => {
    const response = await request(app)
      .post('/webhooks/odeal')
      .set('X-Odeal-Signature', 'invalid')
      .send({ test: 'data' });
      
    expect(response.status).toBe(401);
  });
});
```

---

## Monitoring Webhooks

### Track Delivery Success

```javascript
const webhookMetrics = {
  received: 0,
  processed: 0,
  failed: 0,
  averageProcessingTime: 0
};

app.post('/webhooks/odeal', async (req, res) => {
  const startTime = Date.now();
  webhookMetrics.received++;
  
  try {
    await processWebhook(req.body);
    webhookMetrics.processed++;
    
    const processingTime = Date.now() - startTime;
    webhookMetrics.averageProcessingTime = 
      (webhookMetrics.averageProcessingTime + processingTime) / 2;
      
    res.status(200).send('OK');
  } catch (error) {
    webhookMetrics.failed++;
    console.error('Webhook processing failed:', error);
    res.status(500).send('Error');
  }
});
```

### Log Webhook Events

```javascript
app.post('/webhooks/odeal', async (req, res) => {
  // Log incoming webhook
  logger.info('Webhook received', {
    id: req.body.id,
    type: req.body.type,
    timestamp: new Date().toISOString(),
    ip: req.ip
  });
  
  try {
    await processWebhook(req.body);
    
    logger.info('Webhook processed', {
      id: req.body.id,
      duration: Date.now() - startTime
    });
  } catch (error) {
    logger.error('Webhook processing failed', {
      id: req.body.id,
      error: error.message,
      stack: error.stack
    });
  }
  
  res.status(200).send('OK');
});
```

### Check Delivery Status in Dashboard

View webhook delivery logs in your merchant dashboard:
- Event ID
- Delivery attempts
- Response codes  
- Retry schedule
- Error messages

---

## Best Practices

<AccordionGroup>
  <Accordion title="Respond Quickly">
    ```javascript
    // Return 200 ASAP
    app.post('/webhooks/odeal', async (req, res) => {
      // Validate
      if (!verifySignature(req)) {
        return res.status(401).send('Invalid');
      }
      
      // Respond immediately (< 1s)
      res.status(200).send('OK');
      
      // Process async
      process.nextTick(() => {
        processWebhook(req.body).catch(console.error);
      });
    });
    ```
  </Accordion>
  
  <Accordion title="Handle Retries">
    Ödeal will retry failed webhooks:
    - Immediately
    - After 1 minute
    - After 5 minutes
    - After 30 minutes
    - After 2 hours
    
    **Implement idempotency** to handle duplicates safely.
  </Accordion>
  
  <Accordion title="Validate Event Data">
    ```javascript
    function validateWebhookEvent(event) {
      if (!event.id) throw new Error('Missing event ID');
      if (!event.type) throw new Error('Missing event type');
      if (!event.data) throw new Error('Missing event data');
      
      // Validate event-specific data
      if (event.type === 'payment.succeeded') {
        if (!event.data.paymentId) throw new Error('Missing paymentId');
        if (!event.data.amount) throw new Error('Missing amount');
      }
    }
    ```
  </Accordion>
  
  <Accordion title="Monitor & Alert">
    ```javascript
    // Alert on high failure rate
    if (webhookMetrics.failed / webhookMetrics.received > 0.1) {
      alertOps('High webhook failure rate');
    }
    
    // Alert on processing delays
    if (webhookMetrics.averageProcessingTime > 5000) {
      alertOps('Webhook processing is slow');
    }
    ```
  </Accordion>
</AccordionGroup>

---

## Debugging Checklist

<Steps>
  <Step title="Verify Registration">
    - Webhook URL is registered
    - Events are selected
    - Webhook is active
  </Step>
  
  <Step title="Test Accessibility">
    - Endpoint is publicly accessible
    - HTTPS is working
    - SSL certificate is valid
  </Step>
  
  <Step title="Check Signature">
    - Using correct webhook secret
    - Verifying raw payload
    - Using correct algorithm (HMAC-SHA256)
  </Step>
  
  <Step title="Monitor Performance">
    - Responding within 30s
    - Processing asynchronously
    - Implementing idempotency
  </Step>
  
  <Step title="Review Logs">
    - Check application logs
    - Check webhook delivery logs in dashboard
    - Look for error patterns
  </Step>
</Steps>

---

## Need Help?

<CardGroup cols={2}>
  <Card title="Webhook Guide" icon="webhook" href="/guides/webhooks">
    Complete webhook integration guide
  </Card>
  
  <Card title="Common Errors" icon="triangle-exclamation" href="/troubleshooting/common-errors">
    Other common issues
  </Card>
  
  <Card title="API Reference" icon="code" href="/api-reference/webhooks">
    Webhook API documentation
  </Card>
  
  <Card title="Support" icon="headset" href="/resources/support">
    Contact support team
  </Card>
</CardGroup>
