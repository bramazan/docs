---
title: Webhook'lar
description: Gerçek zamanlı event bildirimleri
---

# Webhook'lar (Webhooks)

Ödeme işlemlerinde gerçekleşen olayları gerçek zamanlı olarak sisteminize bildirmek için kullanılan webhook mekanizması.

## Genel Bakış

Webhook'lar, ödeme süreçlerinde kritik olaylar gerçekleştiğinde sisteminize HTTP POST istekleri gönderir.

### Özellikler

<CardGroup cols={2}>
  <Card title="HMAC İmzalama" icon="shield">
    Tüm webhook'lar HMAC-SHA256 ile imzalanır
  </Card>
  
  <Card title="Otomatik Retry" icon="rotate">
    Başarısız istekler üstel geri çekilme ile yeniden denenir
  </Card>
  
  <Card title="Dead Letter Queue" icon="inbox">
    Sürekli  başarısız olan webhook'lar DLQ'ya taşınır
  </Card>
  
  <Card title="Event Replay" icon="clock-rotate-left">
    Geçmiş event'leri yeniden oynatabilirsiniz
  </Card>
</CardGroup>

---

## Webhook Konfigürasyonu

### Endpoint Kaydı

Webhook endpoint'inizi kaydetmek için destek ekibimizle iletişime geçin:
- Email: support@odeal.com
- Gerekli Bilgiler:
  - Webhook URL'i (HTTPS zorunlu)
  - Dinlemek istediğiniz event tipleri
  - API anahtarınız

<Warning>
Webhook URL'inin HTTPS ile erişilebilir olması zorunludur. HTTP desteklenmez.
</Warning>

---

## Event Tipleri

### Ödeme Event'leri

| Event | Açıklama | Tetiklenme Anı |
|-------|----------|----------------|
| `payment.created` | Ödeme oluşturuldu | İlk ödeme isteği |
| `payment.processing` | Ödeme işleniyor | Banka işleme başladı |
| `payment.requires_action` | Aksiyon gerekli | 3DS doğrulaması gerekli |
| `payment.succeeded` | Ödeme başarılı | İşlem tamamlandı |
| `payment.failed` | Ödeme başarısız | İşlem reddedildi |
| `payment.cancelled` | Ödeme iptal edildi | İşlem iptal edildi |
| `payment.refunded` | Tam iade | İşlem tamamen iade edildi |
| `payment.partially_refunded` | Kısmi iade | İşlem kısmen iade edildi |

### 3D Secure Event'leri

| Event | Açıklama |
|-------|----------|
| `threeds.initiated` | 3DS başlatıldı |
| `threeds.authenticated` | 3DS doğrulandı |
| `threeds.failed` | 3DS başarısız |

### İade Event'leri

| Event | Açıklama |
|-------|----------|
| `refund.processing` | İade işleniyor |
| `refund.completed` | İade tamamlandı |
| `refund.failed` | İade başarısız |

### Dispute Event'leri

| Event | Açıklama |
|-------|----------|
| `dispute.created` | İtiraz oluşturuldu |
| `dispute.won` | İtiraz kazanıldı |
| `dispute.lost` | İtiraz kaybedildi |

---

## Webhook Formatı

### İstek Yapısı

Tüm webhook'lar aşağıdaki formatta gönderilir:

```http
POST https://siteniz.com/webhooks/odeal
Content-Type: application/json
X-Odeal-Signature: sha256=a3b2c1d4e5f6...
X-Odeal-Event-Type: payment.succeeded
X-Odeal-Event-Id: evt_abc123
X-Odeal-Timestamp: 1703001234
```

#### Header'lar

| Header | Açıklama |
|--------|----------|
| `X-Odeal-Signature` | HMAC-SHA256 imzası |
| `X-Odeal-Event-Type` | Event tipi |
| `X-Odeal-Event-Id` | Benzersiz event ID (idempotency için) |
| `X-Odeal-Timestamp` | Unix timestamp |

### Gövde Formatı

```json
{
  "eventId": "evt_abc123",
  "eventType": "payment.succeeded",
  "timestamp": "2025-12-19T18:30:00Z",
  "data": {
    "transactionId": "550e8400-e29b-41d4-a716-446655440000",
    "merchantId": "mrc_abc123",
    "amount": {
      "amount": 100.00,
      "currency": "TRY"
    },
    "status": "Completed",
    "authCode": "123456",
    "rrn": "000123456789"
  }
}
```

---

## İmza Doğrulama

Webhook'ların Ödeal'den geldiğini doğrulamak için HMAC imzasını kontrol edin.

### Doğrulama Kodu

<CodeGroup>
```javascript Node.js
const crypto = require('crypto');

function verifyWebhook(payload, signature, secret) {
  const hmac = crypto
    .createHmac('sha256', secret)
    .update(JSON.stringify(payload))
    .digest('hex');
    
  const expectedSignature = `sha256=${hmac}`;
  
  return crypto.timingSafeEqual(
    Buffer.from(signature),
    Buffer.from(expectedSignature)
  );
}

// Kullanım
app.post('/webhooks/odeal', (req, res) => {
  const signature = req.headers['x-odeal-signature'];
  const isValid = verifyWebhook(req.body, signature, WEBHOOK_SECRET);
  
  if (!isValid) {
    return res.status(401).send('Invalid signature');
  }
  
  // Event'i işle
  handleWebhookEvent(req.body);
  res.status(200).send('OK');
});
```

```python Python
import hmac
import hashlib

def verify_webhook(payload, signature, secret):
    mac = hmac.new(
        secret.encode(),
        payload.encode(),
        hashlib.sha256
    )
    expected = f"sha256={mac.hexdigest()}"
    return hmac.compare_digest(signature, expected)

# Kullanım
@app.route('/webhooks/odeal', methods=['POST'])
def webhook():
    signature = request.headers.get('X-Odeal-Signature')
    payload = request.get_data(as_text=True)
    
    if not verify_webhook(payload, signature, WEBHOOK_SECRET):
        return 'Invalid signature', 401
    
    # Event'i işle
    handle_webhook_event(request.json)
    return 'OK', 200
```

```php PHP
<?php
function verifyWebhook($payload, $signature, $secret) {
    $expected = 'sha256=' . hash_hmac('sha256', $payload, $secret);
    return hash_equals($signature, $expected);
}

// Kullanım
$signature = $_SERVER['HTTP_X_ODEAL_SIGNATURE'];
$payload = file_get_contents('php://input');

if (!verifyWebhook($payload, $signature, WEBHOOK_SECRET)) {
    http_response_code(401);
    die('Invalid signature');
}

// Event'i işle
$event = json_decode($payload, true);
handleWebhookEvent($event);
http_response_code(200);
?>
```
</CodeGroup>

<Warning>
**Güvenlik:** İmza doğrulaması yapmadan webhook'ları işlemeyin. Aksi takdirde sahte istekler işlenebilir.
</Warning>

---

## Retry Mekanizması

Webhook gönderimi başarısız olursa, otomatik olarak yeniden denenir.

### Retry Politikası

| Deneme | Bekleme Süresi | Kümülatif Süre |
|--------|----------------|----------------|
| 1 | Hemen | 0 |
| 2 | 1 dakika | 1 dk |
| 3 | 5 dakika | 6 dk |
| 4 | 15 dakika | 21 dk |
| 5 | 1 saat | 1 saat 21 dk |
| 6 | 6 saat | 7 saat 21 dk |
| 7 | 24 saat | 31 saat 21 dk |

<Note>
7 deneme sonunda hala başarısız olan webhook'lar Dead Letter Queue'ya taşınır ve manuel müdahale gerektirir.
</Note>

### Başarılı Yanıt

Webhook'unuz başarılı işlediğini belirtmek için `200-299` arası HTTP status kodu dönmelidir.

```javascript
// Başarılı
res.status(200).send('OK');
res.status(204).send();

// Başarısız (yeniden denenecek)
res.status(500).send('Internal Error');
res.status(503).send('Service Unavailable');
```

---

## Best Practices

<CardGroup cols={2}>
  <Card title="Hızlı Yanıt Ver" icon="bolt">
    Webhook handler'ınız 5 saniye içinde yanıt vermeli
  </Card>
  
  <Card title="Async İşleme" icon="gears">
    Uzun işlemleri queue'ya al, hemen 200 dön
  </Card>
  
  <Card title="Idempotent Ol" icon="repeat">
    Aynı event birden fazla gelebilir, event ID kontrol et
  </Card>
  
  <Card title="Logla" icon="file-lines">
    Tüm webhook'ları log'la (debugging için)
  </Card>
</CardGroup>

### Örnek İdempotent Implementation

```javascript
const processedEvents = new Set();

function handleWebhook(event) {
  // Event daha önce işlendi mi kontrol et
  if (processedEvents.has(event.eventId)) {
    console.log('Event already processed:', event.eventId);
    return;
  }
  
  // Event'i işle
  processPaymentEvent(event.data);
  
  // İşlendiğini kaydet
  processedEvents.add(event.eventId);
}
```

---

## Test Etme

### Test Webhook Gönderme

Development ortamında webhook'larınızı test edebilirsiniz:

```bash
POST /v1/webhooks/test
Authorization: Bearer API_ANAHTARINIZ
Content-Type: application/json
```

```json
{
  "endpoint": "https://siteniz.com/webhooks/test",
  "eventType": "payment.succeeded",
  "testData": {
    "transactionId": "test_123",
    "amount": 100.00
  }
}
```

### Local Test (ngrok)

Local geliştirme için [ngrok](https://ngrok.com) kullanabilirsiniz:

```bash
# ngrok başlat
ngrok http 3000

# Ödeal'e verilen URL
https://abc123.ngrok.io/webhooks/odeal
```

---

## Sorun Giderme

| Sorun | Çözüm |
|-------|--------|
| Webhook gelmiyor | URL'in HTTPS olduğundan emin olun |
| İmza hatası | Secret key'in doğru olduğunu kontrol edin |
| Timeout | Handler'ınız 5 saniye içinde yanıt vermeli |
| Duplicate event'ler | Event ID ile idempotency sağlayın |

---

## İlgili Kaynaklar

- [Ödeme API](/api-reference/payments)
- [Event Tipleri](#event-tipleri)
- [Best Practices](#best-practices)
